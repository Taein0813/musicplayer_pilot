<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Perception Study</title>

  <style>
    body { margin:0; background:#111; color:#eee; font-family: system-ui, -apple-system, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px 24px 24px; }

    /* DEBUG - 참가자에게 보이지 않도록 숨김 처리 */
    .debugBox {
      display: none; /* 실제 실험 시 숨김, 확인 필요 시 block으로 변경 */
      background:#0d1b2a;
      border:1px solid #1b3a57;
      border-radius:12px;
      padding:10px 12px;
      margin: 10px 0 14px;
      font-size: 12.5px;
      color:#cfe7ff;
      white-space: pre-wrap;
    }

    .card  { background:#1b1b1b; border:1px solid #2a2a2a; border-radius: 16px; padding: 18px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; }
    .counter { font-size: 18px; opacity: .9; }
    .status  { font-size: 14px; opacity: .75; color: #2b6cff; font-weight: bold; }

    .panel { display:grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    .small { font-size: 13px; opacity: .75; }

    /* ===== Frame + Overlay (앨범아트 위치 교정) ===== */
    .playerFrame {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 24px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);

      /* 앨범아트 위치 미세 조정 (제공해주신 이미지 비율에 맞춤) */
      --art-left: 10%;
      --art-top: 20%;
      --art-size: 80%;
      
      --play-left: 50%;
      --play-top: 85%;
    }
    .frameImg { width: 100%; height: auto; display:block; user-select:none; pointer-events: none; }
    
    .albumSlot {
      position: absolute;
      left: var(--art-left);
      top: var(--art-top);
      width: var(--art-size);
      height: 0;
      padding-bottom: var(--art-size); /* 1:1 비율 유지 */
      border-radius: 12px;
      overflow: hidden;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .albumSlot img { 
      position: absolute;
      top: 0; left: 0;
      width:100%; height:100%; 
      object-fit:cover; 
      display:block; 
    }

    .playOverlay {
      position: absolute;
      left: var(--play-left);
      top: var(--play-top);
      transform: translate(-50%, -50%);
      border: 0;
      border-radius: 999px;
      padding: 10px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(255,255,255,1);
      color: #000;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.1s;
    }
    .playOverlay:active { transform: translate(-50%, -50%) scale(0.95); }

    .controls { display:flex; gap: 12px; align-items:center; margin-top: 20px; justify-content:center; }
    .btn { border:0; border-radius:12px; padding:14px 24px; font-size:16px; font-weight:bold; cursor:pointer; transition: 0.2s; }
    .btn-primary { background:#2b6cff; color:#fff; width: 100%; }
    .btn-primary:hover { background: #1a56e0; }
    .btn:disabled { background:#444; color:#888; cursor:not-allowed; }

    /* Sliders */
    .sl { margin: 20px 0 30px; }
    .sl label { display:flex; justify-content:space-between; align-items:center; font-size:16px; margin-bottom: 12px; font-weight: 500; }
    input[type="range"] { width:100%; cursor: pointer; }
    .value { font-family: monospace; font-size: 18px; color: #2b6cff; }

    .screen { display:none; }
    .screen.active { display:block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 860px){
      .panel { grid-template-columns: 1fr; }
      .playerFrame { max-width: 380px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="debugBox" id="debugBox">DEBUG\nInitializing...</div>

    <div class="screen active" id="screenStart">
      <div class="card">
        <h2 style="margin-top:0;">연구 참가 안내</h2>
        <p>참가자 ID 또는 성함을 입력하고 시작해주세요.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px;">
          <input id="pid" type="text" placeholder="ID 입력 (예: P01)" style="padding:14px; border-radius:10px; border:1px solid #333; background:#222; color:#eee; flex:1;">
          <button class="btn btn-primary" id="btnStart" style="width:auto;">실험 시작</button>
        </div>
        <p class="small">※ 모든 데이터는 연구 목적으로만 사용되며 안전하게 저장됩니다.</p>
      </div>
    </div>

    <div class="screen" id="screenInst">
      <div class="card">
        <h2 style="margin-top:0;">실험 방법</h2>
        <p>1. <b>Play</b> 버튼을 누르면 음악이 <b>10초</b>간 재생됩니다.</p>
        <p>2. 음악을 들으면서 느껴지는 정서가(Valence), 각성도(Arousal)를 아래 슬라이더로 평가해주세요.</p>
        <p>3. 재생이 끝나면 <b>Next</b> 버튼이 활성화됩니다.</p>
        <button class="btn btn-primary" id="btnGo">이해했습니다</button>
      </div>
    </div>

    <div class="screen" id="screenTrial">
      <div class="topbar">
        <div class="counter" id="counter">1/16</div>
        <div class="status" id="status">준비됨</div>
      </div>

      <div class="panel">
        <div class="card">
          <div class="playerFrame">
            <img class="frameImg" id="frameImg" src="stimuli/music_player.png" alt="player frame" />
            <div class="albumSlot">
              <img id="artImg" src="" alt="album art"/>
            </div>
            <button class="playOverlay" id="playBtn">Play</button>
            <audio id="audio" preload="auto" crossorigin="anonymous"></audio>
          </div>
          <div class="controls">
            <button class="btn btn-primary" id="nextBtn" disabled>Next Trial</button>
          </div>
        </div>

        <div class="card">
          <div class="sl">
            <label><span>Valence (정서가)</span><span class="value" id="valTxt">50</span></label>
            <input id="valence" type="range" min="0" max="100" step="1" value="50" />
          </div>
          <div class="sl">
            <label><span>Arousal (각성도)</span><span class="value" id="aroTxt">50</span></label>
            <input id="arousal" type="range" min="0" max="100" step="1" value="50" />
          </div>
          <div style="opacity: 0.6; font-size: 0.9em; line-height: 1.5;">
            * Valence: 매우 부정적인(0) ~ 매우 긍정적인(100)<br>
            * Arousal: 매우 이완된, 차분한(0) ~ 매우 각성된, 강렬한(100)
          </div>
        </div>
      </div>
    </div>

    <div class="screen" id="screenEnd">
      <div class="card" style="text-align:center;">
        <h2 style="margin-top:0;">실험이 완료되었습니다.</h2>
        <p>데이터가 성공적으로 전송되었습니다. 참여해주셔서 감사합니다.</p>
        <p class="small">만약을 대비해 아래 버튼을 눌러 결과 파일을 소지해 주시면 감사하겠습니다.</p>
        <button class="btn" id="btnDownload" style="background: #333; color: #ccc;">Download JSON (Backup)</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 * 설정 및 데이터 (수정된 URL 적용)
 * ========================= */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzRK8Ii1JMouDxNxZb7xA9jljphbq_AnT3Ho_tCeyjxF_aO057b6kXNTE6XNL59Za44/exec";
const PLAY_MS = 10000;
const FRAME_IMG = "stimuli/music_player.png";
const DEFAULT_ART = "stimuli/no_album.jpg";

const baseStimuli = [
  { stim_id: "cheerful1", audio: "stimuli/cheerful1.mp3", art: "stimuli/cheerful1.png" },
  { stim_id: "cheerful2", audio: "stimuli/cheerful2.mp3", art: "stimuli/cheerful2.png" },
  { stim_id: "calm1",     audio: "stimuli/calm1.mp3",     art: "stimuli/calm1.png" },
  { stim_id: "calm2",     audio: "stimuli/calm2.mp3",     art: "stimuli/calm2.png" },
  { stim_id: "tense1",    audio: "stimuli/tense1.mp3",    art: "stimuli/tense1.png" },
  { stim_id: "tense2",    audio: "stimuli/tense2.mp3",    art: "stimuli/tense2.png" },
  { stim_id: "sad1",      audio: "stimuli/sad1.mp3",      art: "stimuli/sad1.png" },
  { stim_id: "sad2",      audio: "stimuli/sad2.mp3",      art: "stimuli/sad2.png" },
];

/** =========================
 * 데이터 전송 및 큐 관리
 * ========================= */
const QUEUE_KEY = "exp_fallback_queue";
function loadQueue(){ try { return JSON.parse(localStorage.getItem(QUEUE_KEY)||"[]"); } catch { return []; } }
function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }

async function sendToSheet(payload){
  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain" }, // CORS 프리플라이트 방지를 위해 text/plain 사용 가능
      body: JSON.stringify(payload),
    });
    return { ok: res.ok };
  } catch (e) {
    return { ok: false, error: e };
  }
}

async function flushQueue(){
  const q = loadQueue();
  if(!q.length) return;
  const remain = [];
  for(const item of q){
    const r = await sendToSheet(item);
    if(!r.ok) remain.push(item);
  }
  saveQueue(remain);
}

/** =========================
 * 실험 로직
 * ========================= */
function buildTrials(){
  const out=[];
  baseStimuli.forEach(s => {
    out.push({...s, condition:"art", show_art:true});
    out.push({...s, condition:"noart", show_art:false});
  });
  return out;
}

function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

// 동일 자극 연속 방지 셔플
function getSmartShuffle(arr){
  let result = shuffle([...arr]);
  for(let i=1; i<result.length; i++){
    if(result[i].stim_id === result[i-1].stim_id){
      return getSmartShuffle(arr); // 재시도
    }
  }
  return result;
}

const trials = getSmartShuffle(buildTrials());
let participant_id = "";
let trialIndex = 0;
const results = [];
let playedOnce = false;
let timer = null;

const S = {
  start: document.getElementById("screenStart"),
  inst: document.getElementById("screenInst"),
  trial: document.getElementById("screenTrial"),
  end: document.getElementById("screenEnd"),
};

function show(screen){
  Object.values(S).forEach(el => el.classList.remove("active"));
  screen.classList.add("active");
}

function loadTrial(i){
  const t = trials[i];
  document.getElementById("counter").textContent = `${i+1} / ${trials.length}`;
  document.getElementById("status").textContent = "준비됨";
  document.getElementById("artImg").src = t.show_art ? t.art : DEFAULT_ART;
  
  const audio = document.getElementById("audio");
  audio.src = t.audio;
  audio.load();

  playedOnce = false;
  document.getElementById("nextBtn").disabled = true;
  document.getElementById("playBtn").textContent = "Play";
  
  // 슬라이더 초기화
  document.getElementById("valence").value = 50;
  document.getElementById("arousal").value = 50;
  updateSliderText();
}

function updateSliderText(){
  document.getElementById("valTxt").textContent = document.getElementById("valence").value;
  document.getElementById("aroTxt").textContent = document.getElementById("arousal").value;
}

document.getElementById("valence").oninput = updateSliderText;
document.getElementById("arousal").oninput = updateSliderText;

document.getElementById("btnStart").onclick = () => {
  participant_id = document.getElementById("pid").value.trim();
  if(!participant_id) return alert("ID를 입력해주세요.");
  show(S.inst);
};

document.getElementById("btnGo").onclick = () => {
  loadTrial(0);
  show(S.trial);
};

document.getElementById("playBtn").onclick = async () => {
  const audio = document.getElementById("audio");
  const btn = document.getElementById("playBtn");
  const status = document.getElementById("status");

  if(audio.paused){
    try {
      await audio.play();
      btn.textContent = "Pause";
      status.textContent = "재생 중...";
      
      if(timer) clearTimeout(timer);
      timer = setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
        btn.textContent = "Play";
        status.textContent = "재생 완료";
        playedOnce = true;
        document.getElementById("nextBtn").disabled = false;
      }, PLAY_MS);
    } catch(e) { alert("오디오 재생에 실패했습니다. 파일을 확인해주세요."); }
  } else {
    audio.pause();
    btn.textContent = "Play";
    status.textContent = "일시정지";
  }
};

document.getElementById("nextBtn").onclick = async () => {
  const t = trials[trialIndex];
  const payload = {
    pid: participant_id,
    trial: trialIndex + 1,
    stim: t.stim_id,
    cond: t.condition,
    val: document.getElementById("valence").value,
    aro: document.getElementById("arousal").value,
    time: new Date().toLocaleString()
  };

  results.push(payload);
  
  // 즉시 전송 시도
  const res = await sendToSheet(payload);
  if(!res.ok){
    const q = loadQueue();
    q.push(payload);
    saveQueue(q);
  }

  trialIndex++;
  if(trialIndex < trials.length){
    loadTrial(trialIndex);
  } else {
    await flushQueue();
    show(S.end);
  }
};

document.getElementById("btnDownload").onclick = () => {
  const blob = new Blob([JSON.stringify(results, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `results_${participant_id}.json`;
  a.click();
};
</script>
</body>
</html>
