<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>musicplayer_pilot</title>

  <style>
    body { margin:0; background:#111; color:#eee; font-family: system-ui, -apple-system, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px 24px 24px; }

    /* DEBUG */
    .debugBox{
      background:#0d1b2a;
      border:1px solid #1b3a57;
      border-radius:12px;
      padding:10px 12px;
      margin: 10px 0 14px;
      font-size: 12.5px;
      line-height: 1.35;
      color:#cfe7ff;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .card  { background:#1b1b1b; border:1px solid #2a2a2a; border-radius: 16px; padding: 18px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; }
    .counter { font-size: 18px; opacity: .9; }
    .status  { font-size: 14px; opacity: .75; }

    .panel { display:grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    .small { font-size: 13px; opacity: .75; }

    /* ===== Frame + overlay ===== */
    .playerFrame {
      position: relative;
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      border-radius: 18px;
      overflow: hidden;
      background: #000;
      border: 1px solid #2a2a2a;

      /* â˜… ì—¬ê¸° 3ê°œ ì¡°ì ˆí•˜ë©´ ì•¨ë²”ì•„íŠ¸ ìœ„ì¹˜/í¬ê¸° ì •í™•íˆ ë§ìŒ */
      --art-left: 12.5%;
      --art-top: 12.0%;
      --art-size: 76.0%;

      --play-left: 50%;
      --play-top: 82%;
    }
    .frameImg { width: 100%; height: auto; display:block; user-select:none; -webkit-user-drag:none; }
    .albumSlot {
      position: absolute;
      left: var(--art-left);
      top: var(--art-top);
      width: var(--art-size);
      height: var(--art-size);
      border-radius: 10px;
      overflow: hidden;
      background: #000;
    }
    .albumSlot img { width:100%; height:100%; object-fit:cover; display:block; }
    .playOverlay {
      position: absolute;
      left: var(--play-left);
      top: var(--play-top);
      transform: translate(-50%, -50%);
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      color: #111;
      min-width: 100px;
      backdrop-filter: blur(4px);
    }

    .controls { display:flex; gap: 12px; align-items:center; margin-top: 14px; justify-content:center; flex-wrap:wrap; }
    .btn { border:0; border-radius:999px; padding:12px 16px; font-size:16px; cursor:pointer; }
    .btn-primary { background:#2b6cff; color:#fff; min-width: 90px; }
    .btn-white { background:#fff; color:#111; min-width: 110px; }
    .btn:disabled { opacity:.45; cursor:not-allowed; }

    .hint { margin-top: 10px; font-size: 13px; opacity:.7; line-height: 1.4; text-align:center; }

    /* sliders */
    .sl { margin: 10px 0 18px; }
    .sl label { display:flex; justify-content:space-between; align-items:center; font-size:15px; margin-bottom: 8px; }
    input[type="range"] { width:100%; }
    .value { font-variant-numeric: tabular-nums; opacity:.9; }

    /* screens */
    .screen { display:none; }
    .screen.active { display:block; }

    @media (max-width: 860px){
      .panel { grid-template-columns: 1fr; }
      .playerFrame { max-width: 420px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="debugBox" id="debugBox">DEBUG\nLoadingâ€¦</div>

    <!-- START -->
    <div class="screen active" id="screenStart">
      <div class="card">
        <h2 style="margin-top:0;">ì°¸ê°€ì ì •ë³´</h2>
        <p>ID/ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input id="pid" type="text" placeholder="ì˜ˆ: P001" style="padding:10px 12px;border-radius:10px;border:1px solid #333;background:#111;color:#eee;min-width:220px;">
          <button class="btn btn-primary" id="btnStart">Start</button>
        </div>
        <p class="small">â€» ì…ë ¥í•œ IDì™€ í•¨ê»˜ Google Sheetë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="screen" id="screenInst">
      <div class="card">
        <h2 style="margin-top:0;">ì•ˆë‚´</h2>
        <p>ê° íŠ¸ë¼ì´ì–¼ì—ì„œ <b>Play</b>ë¥¼ ëˆ„ë¥´ë©´ ìŒì•…ì´ <b>10ì´ˆ</b> ì¬ìƒë©ë‹ˆë‹¤.</p>
        <p>ì¬ìƒì´ ëë‚˜ë©´ Valence/Arousal(0â€“100)ì„ í‰ê°€í•˜ê³  <b>Next</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
        <p class="small">ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ì¬ìƒì€ ë¶ˆê°€ëŠ¥í•´ì„œ Play í´ë¦­ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-primary" id="btnGo">Go</button>
      </div>
    </div>

    <!-- TRIAL -->
    <div class="screen" id="screenTrial">
      <div class="topbar">
        <div class="counter" id="counter">1/16</div>
        <div class="status" id="status">ì¤€ë¹„ë¨</div>
      </div>

      <div class="panel">
        <div class="card">
          <div class="playerFrame">
            <img class="frameImg" id="frameImg" src="" alt="player frame" />
            <div class="albumSlot">
              <img id="artImg" src="" alt="album art"/>
            </div>
            <button class="playOverlay btn-white" id="playBtn">Play</button>

            <audio id="audio" preload="auto" crossorigin="anonymous"></audio>
          </div>

          <div class="controls">
            <button class="btn btn-primary" id="nextBtn" disabled>Next</button>
          </div>

          <div class="hint" id="hint">
            â€¢ Playë¥¼ ëˆ„ë¥´ë©´ 10ì´ˆ ì¬ìƒ í›„ ìë™ìœ¼ë¡œ ë©ˆì¶¥ë‹ˆë‹¤.<br/>
            â€¢ ì¬ìƒì´ 1íšŒ ì´ìƒ ì™„ë£Œë˜ì–´ì•¼ Nextê°€ í™œì„±í™”ë©ë‹ˆë‹¤.
          </div>
          <div class="hint small" id="netHint"></div>
        </div>

        <div class="card">
          <div class="sl">
            <label><span>Valence (0â€“100)</span><span class="value" id="valTxt">50</span></label>
            <input id="valence" type="range" min="0" max="100" step="1" value="50" />
          </div>
          <div class="sl">
            <label><span>Arousal (0â€“100)</span><span class="value" id="aroTxt">50</span></label>
            <input id="arousal" type="range" min="0" max="100" step="1" value="50" />
          </div>
        </div>
      </div>
    </div>

    <!-- END -->
    <div class="screen" id="screenEnd">
      <div class="card" style="text-align:center;">
        <h2 style="margin-top:0;">ë!</h2>
        <p>ë§ˆì§€ë§‰ìœ¼ë¡œ ë¯¸ì „ì†¡ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ì „ì†¡ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤.</p>
        <button class="btn btn-primary" id="btnDownload">Download JSON</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 * 0) ì„¤ì • (ë„ˆ URL)
 * ========================= */
const GOOGLE_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbx15kYuTQuzEXWxZnghgcGFXiYIDdUJq_LnQ-iXUmwAUZE5Jpy_gcvBMfqsnhQH4ZNN/exec";

const PLAY_MS = 10_000;
const FRAME_IMG = "stimuli/music_player.png";
const DEFAULT_ART = "stimuli/no_album.jpg";

const baseStimuli = [
  { stim_id: "cheerful1", audio: "stimuli/cheerful1.mp3", art: "stimuli/cheerful1.png" },
  { stim_id: "cheerful2", audio: "stimuli/cheerful2.mp3", art: "stimuli/cheerful2.png" },
  { stim_id: "calm1",     audio: "stimuli/calm1.mp3",     art: "stimuli/calm1.png" },
  { stim_id: "calm2",     audio: "stimuli/calm2.mp3",     art: "stimuli/calm2.png" },
  { stim_id: "tense1",    audio: "stimuli/tense1.mp3",    art: "stimuli/tense1.png" },
  { stim_id: "tense2",    audio: "stimuli/tense2.mp3",    art: "stimuli/tense2.png" },
  { stim_id: "sad1",      audio: "stimuli/sad1.mp3",      art: "stimuli/sad1.png" },
  { stim_id: "sad2",      audio: "stimuli/sad2.mp3",      art: "stimuli/sad2.png" },
];

/** =========================
 * 1) DEBUG
 * ========================= */
const dbgEl = document.getElementById("debugBox");
let dbgLines = [];
function dbg(msg){
  dbgLines.push(msg);
  if(dbgLines.length > 60) dbgLines = dbgLines.slice(-60);
  dbgEl.textContent = "DEBUG\n" + dbgLines.join("\n");
}
window.addEventListener("error", (e) => dbg("âŒ window.error: " + (e.message || e.type)));
window.addEventListener("unhandledrejection", (e) => dbg("âŒ unhandledrejection: " + (e.reason?.message || e.reason)));

/** quick file check */
async function check(url){
  try{
    const r = await fetch(url, { method:"GET", cache:"no-store" });
    dbg(`${r.ok ? "âœ…" : "âŒ"} ${url} (${r.status})`);
  } catch(e){
    dbg(`âŒ ${url} (ERR)`);
  }
}
(async () => {
  dbg("ğŸ” checking key filesâ€¦");
  await check(FRAME_IMG);
  await check(DEFAULT_ART);
  await check("stimuli/cheerful1.mp3");
  await check("stimuli/cheerful1.png");
})();

/** =========================
 * 2) Trials ë§Œë“¤ê¸° + ê°™ì€ ê³¡ ì—°ì† ë°©ì§€
 * ========================= */
function buildTrials(){
  const out=[];
  for(const s of baseStimuli){
    out.push({...s, condition:"art", show_art:true});
    out.push({...s, condition:"noart", show_art:false});
  }
  return out;
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function shuffleNoAdjacentSame(arr, key="stim_id", maxTry=5000){
  for(let t=0;t<maxTry;t++){
    const cand = shuffle(arr);
    let ok=true;
    for(let i=1;i<cand.length;i++){
      if(cand[i][key]===cand[i-1][key]) { ok=false; break; }
    }
    if(ok) return cand;
  }
  return arr;
}

const trials = shuffleNoAdjacentSame(buildTrials(), "stim_id");

/** =========================
 * 3) Google Sheet ì „ì†¡ (POST -> ì‹¤íŒ¨ì‹œ GET fallback)
 * ========================= */
const QUEUE_KEY = "unsent_responses_v2";
function loadQueue(){ try { return JSON.parse(localStorage.getItem(QUEUE_KEY)||"[]"); } catch { return []; } }
function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }

async function sendPOST(payload){
  const res = await fetch(GOOGLE_SCRIPT_URL, {
    method:"POST",
    mode:"cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload),
  });
  const text = await res.text();
  if(!res.ok) throw new Error(`POST ${res.status}: ${text}`);
  return text;
}

// doGetë§Œ ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë„ ë§ì•„ì„œ GETë„ ê°™ì´ ì§€ì›
async function sendGET(payload){
  const url = new URL(GOOGLE_SCRIPT_URL);
  Object.entries(payload).forEach(([k,v]) => url.searchParams.set(k, String(v)));
  // CORS íšŒí”¼ìš©: no-corsë¡œ ë³´ë‚´ë©´ ì‘ë‹µì€ ëª» ì½ì§€ë§Œ ì „ì†¡ì€ ë¨(ì„œë²„ê°€ í—ˆìš©í•˜ë©´)
  await fetch(url.toString(), { method:"GET", mode:"no-cors" });
  return "GET sent (no-cors)";
}

async function sendToSheet(payload){
  try{
    const r = await sendPOST(payload);
    return { ok:true, via:"POST", resp:r };
  } catch(e){
    dbg("âš ï¸ POST failed -> try GET: " + (e.message||e));
    try{
      const r2 = await sendGET(payload);
      return { ok:true, via:"GET", resp:r2 };
    } catch(e2){
      return { ok:false, via:"NONE", resp:(e2.message||e2) };
    }
  }
}

async function flushQueue(){
  const q = loadQueue();
  if(!q.length) return { sent:0, left:0 };
  dbg(`ğŸ“¦ queue flush start: ${q.length}`);
  const remain=[];
  let sent=0;
  for(const item of q){
    const r = await sendToSheet(item);
    if(r.ok) sent++; else remain.push(item);
  }
  saveQueue(remain);
  dbg(`ğŸ“¦ queue flush done: sent=${sent}, left=${remain.length}`);
  return { sent, left:remain.length };
}

/** =========================
 * 4) í™”ë©´ ì œì–´
 * ========================= */
const S = {
  start: document.getElementById("screenStart"),
  inst: document.getElementById("screenInst"),
  trial: document.getElementById("screenTrial"),
  end: document.getElementById("screenEnd"),
};
function show(screen){
  Object.values(S).forEach(el => el.classList.remove("active"));
  screen.classList.add("active");
}

let participant_id = "";
let trialIndex = 0;
const results = [];

document.getElementById("btnStart").addEventListener("click", async () => {
  const pid = (document.getElementById("pid").value || "").trim();
  if(!pid){ alert("ID/ì´ë¦„ì„ ì…ë ¥í•´ì¤˜."); return; }
  participant_id = pid;
  dbg("ğŸ‘¤ participant_id=" + participant_id);
  try { await flushQueue(); } catch {}
  show(S.inst);
});

document.getElementById("btnGo").addEventListener("click", () => {
  trialIndex = 0;
  loadTrial(trialIndex);
  show(S.trial);
});

/** =========================
 * 5) Trial ë™ì‘
 * ========================= */
const counterEl = document.getElementById("counter");
const statusEl  = document.getElementById("status");
const hintEl    = document.getElementById("hint");
const netHintEl = document.getElementById("netHint");

const frameImg = document.getElementById("frameImg");
const artImg   = document.getElementById("artImg");
const audioEl  = document.getElementById("audio");
const playBtn  = document.getElementById("playBtn");
const nextBtn  = document.getElementById("nextBtn");

const valenceEl = document.getElementById("valence");
const arousalEl = document.getElementById("arousal");
const valTxt = document.getElementById("valTxt");
const aroTxt = document.getElementById("aroTxt");

function syncSlider(){
  valTxt.textContent = valenceEl.value;
  aroTxt.textContent = arousalEl.value;
}
valenceEl.addEventListener("input", syncSlider);
arousalEl.addEventListener("input", syncSlider);

let timer = null;
let playedOnce = false;

function loadTrial(i){
  const t = trials[i];
  counterEl.textContent = `${i+1}/${trials.length}`;
  statusEl.textContent = "ì¤€ë¹„ë¨";
  netHintEl.textContent = "";
  hintEl.innerHTML = "â€¢ Playë¥¼ ëˆ„ë¥´ë©´ 10ì´ˆ ì¬ìƒ í›„ ìë™ìœ¼ë¡œ ë©ˆì¶¥ë‹ˆë‹¤.<br/>â€¢ ì¬ìƒì´ 1íšŒ ì´ìƒ ì™„ë£Œë˜ì–´ì•¼ Nextê°€ í™œì„±í™”ë©ë‹ˆë‹¤.";

  frameImg.src = FRAME_IMG;
  artImg.src = t.show_art ? t.art : DEFAULT_ART;

  // reset audio
  if(timer) clearTimeout(timer);
  timer = null;
  playedOnce = false;
  nextBtn.disabled = true;
  playBtn.textContent = "Play";
  try { audioEl.pause(); audioEl.currentTime = 0; } catch {}
  audioEl.src = t.audio;
  audioEl.load();

  // reset sliders
  valenceEl.value = 50;
  arousalEl.value = 50;
  syncSlider();

  dbg(`ğŸ§ trial ${i+1}: ${t.stim_id} / ${t.condition}`);
}

function enableNext(){
  playedOnce = true;
  nextBtn.disabled = false;
  hintEl.textContent = "ì´ì œ Nextë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
}

playBtn.addEventListener("click", async () => {
  try{
    if(audioEl.paused){
      await audioEl.play();
      statusEl.textContent = "ì¬ìƒ ì¤‘ (10ì´ˆ)";
      playBtn.textContent = "Pause";

      if(timer) clearTimeout(timer);
      timer = setTimeout(() => {
        try { audioEl.pause(); audioEl.currentTime = 0; } catch {}
        statusEl.textContent = "ì¬ìƒ ì™„ë£Œ";
        playBtn.textContent = "Play";
        enableNext();
      }, PLAY_MS);
    } else {
      audioEl.pause();
      statusEl.textContent = "ì¼ì‹œì •ì§€";
      playBtn.textContent = "Play";
    }
  } catch(e){
    dbg("âŒ audio play error: " + (e.message||e));
    statusEl.textContent = "ì¬ìƒ ì‹¤íŒ¨(í˜¸ìŠ¤íŒ…/íŒŒì¼ í™•ì¸)";
  }
});

nextBtn.addEventListener("click", async () => {
  const t = trials[trialIndex];

  if(timer) clearTimeout(timer);
  timer = null;
  try { audioEl.pause(); audioEl.currentTime = 0; } catch {}

  const payload = {
    participant_id,
    trial_index: trialIndex + 1,
    total_trials: trials.length,
    stim_id: t.stim_id,
    condition: t.condition,
    audio: t.audio,
    art_shown: (t.show_art ? t.art : DEFAULT_ART),
    valence: Number(valenceEl.value),
    arousal: Number(arousalEl.value),
    played_once: playedOnce,
    client_timestamp: new Date().toISOString(),
    user_agent: navigator.userAgent
  };

  results.push(payload);

  netHintEl.textContent = "ì €ì¥ ì¤‘â€¦";
  const r = await sendToSheet(payload);
  if(r.ok){
    netHintEl.textContent = `âœ… ì €ì¥ ì™„ë£Œ (${r.via})`;
    dbg(`âœ… sent (${r.via}) trial ${trialIndex+1}`);
    // í˜¹ì‹œ ì´ì „ íê°€ ë‚¨ì•„ìˆìœ¼ë©´ í•œë²ˆ ë” flush
    try { await flushQueue(); } catch {}
  } else {
    const q = loadQueue(); q.push(payload); saveQueue(q);
    netHintEl.textContent = "âš ï¸ ì „ì†¡ ì‹¤íŒ¨ â†’ ì„ì‹œ ì €ì¥(ë‚˜ì¤‘ì— ì¬ì „ì†¡)";
    dbg("âš ï¸ send failed queued: " + r.resp);
  }

  trialIndex += 1;
  if(trialIndex >= trials.length){
    dbg("ğŸ end reached. flushing queueâ€¦");
    try { await flushQueue(); } catch {}
    show(S.end);
    return;
  }
  loadTrial(trialIndex);
});

document.getElementById("btnDownload").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(results, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "va_data.json";
  a.click();
  URL.revokeObjectURL(url);
});

/** init */
dbg("âœ… vanilla experiment loaded (no jsPsych).");
</script>
</body>
</html>
