<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Perception Study</title>

  <style>
    body { margin:0; background:#111; color:#eee; font-family: system-ui, -apple-system, Arial, sans-serif; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px 24px 24px; }

    .debugBox { display: none; }

    .card { background:#1b1b1b; border:1px solid #2a2a2a; border-radius: 16px; padding: 20px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; max-width: 850px; margin-left: auto; margin-right: auto; }
    .counter { font-size: 18px; opacity: .9; }
    .status { font-size: 14px; opacity: .75; color: #2b6cff; font-weight: bold; }

    .panel { display:grid; grid-template-columns: 340px 1fr; gap: 24px; align-items: stretch; max-width: 850px; margin: 0 auto; }

    /* ===== Frame + Overlay ===== */
    .playerFrame {
      position: relative;
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      border-radius: 28px; 
      overflow: hidden;
      background: #111;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);

      --art-left: 10.0%;
      --art-top: 14.2%;
      --art-size: 80%;
      --play-left: 50%;
      --play-top: 82.7%;
    }

    .frameImg { width: 100%; height: auto; display:block; user-select:none; pointer-events: none; image-rendering: -webkit-optimize-contrast; }

    .albumSlot {
      position: absolute;
      left: var(--art-left);
      top: var(--art-top);
      width: var(--art-size);
      height: 0;
      padding-bottom: var(--art-size); 
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      z-index: 1;
    }
    .albumSlot img { position: absolute; top: 0; left: 0; width:100%; height:100%; object-fit:cover; display:block; }

    /* Play 버튼: 하얀 동그라미 + 까만 글씨 */
    .playOverlay {
      position: absolute;
      left: var(--play-left);
      top: var(--play-top);
      transform: translate(-50%, -50%);
      width: 50px; height: 50px;
      border: 0; border-radius: 50%; 
      background: #ffffff; color: #000000;
      font-size: 14px; font-weight: 800;
      text-transform: uppercase;
      cursor: pointer; z-index: 10;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      outline: none; -webkit-tap-highlight-color: transparent;
      transition: all 0.2s ease;
    }
    .playOverlay:hover { background: #f0f0f0; transform: translate(-50%, -50%) scale(1.05); }
    .playOverlay:active { background: #dddddd; transform: translate(-50%, -50%) scale(0.95); }

    .controls { margin-top: auto; padding-top: 20px; }
    .btn { border:0; border-radius:12px; padding:16px 20px; font-size:16px; font-weight:bold; cursor:pointer; transition: 0.2s; }
    .btn-primary { background:#2b6cff; color:#fff; width: 100%; }
    .btn:disabled { background:#333; color:#666; cursor:not-allowed; }

    /* Sliders */
    .sl { margin-bottom: 35px; }
    .sl label { display:flex; justify-content:space-between; align-items:center; font-size:16px; margin-bottom: 12px; font-weight: bold; }
    input[type="range"] { width:100%; cursor: pointer; height: 6px; border-radius: 5px; background: #333; accent-color: #2b6cff; margin: 10px 0; }
    .value { font-family: monospace; font-size: 18px; color: #2b6cff; }
    .sl-guide { display: flex; justify-content: space-between; font-size: 12px; opacity: 0.6; margin-top: -5px; }

    .screen { display:none; }
    .screen.active { display:block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 800px){
      .panel { grid-template-columns: 1fr; }
      .playerFrame { max-width: 300px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="screen active" id="screenStart">
      <div class="card" style="max-width: 500px; margin: 40px auto;">
        <h2 style="margin-top:0; color:#2b6cff;">연구 참가 안내</h2>
        <p>참가자 ID 또는 성함을 입력하고 시작해주세요.</p>
        <div style="display:flex; flex-direction:column; gap:12px;">
          <input id="pid" type="text" placeholder="ID 입력 (예: P01)" style="padding:15px; border-radius:10px; border:1px solid #333; background:#222; color:#eee; font-size:16px;">
          <button class="btn btn-primary" id="btnStart">실험 시작</button>
        </div>
      </div>
    </div>

    <div class="screen" id="screenInst">
      <div class="card" style="max-width: 500px; margin: 40px auto;">
        <h2 style="margin-top:0;">실험 방법</h2>
        <p>1. <b>하단 중앙의 재생 버튼(PLAY)</b>을 누르면 음악이 <b>10초</b>간 재생됩니다.</p>
        <p>2. <b>이 음악이 표현하고 있다고 생각되는 감정</b>을 우측 슬라이더로 평가해주세요.</p>
        <p>3. 평가를 마친 후 <b>[다음 곡으로]</b> 버튼을 눌러주세요.</p>
        <p>4. <b>새로고침 시 데이터가 초기화</b>되니 주의해주세요.</p>
        <button class="btn btn-primary" id="btnGo">실험 시작</button>
      </div>
    </div>

    <div class="screen" id="screenTrial">
      <div class="topbar">
        <div class="counter" id="counter">1/16</div>
        <div class="status" id="status">준비됨</div>
      </div>

      <div class="panel">
        <div class="card" style="align-items: center; justify-content: center;">
          <div class="playerFrame">
            <img class="frameImg" id="frameImg" src="stimuli/music_player.png" alt="player frame" />
            <div class="albumSlot">
              <img id="artImg" src="" alt="album art"/>
            </div>
            <button class="playOverlay" id="playBtn">Play</button>
            <audio id="audio" preload="auto" crossorigin="anonymous"></audio>
          </div>
        </div>

        <div class="card">
          <div class="sl">
            <label><span>Valence (정서가)</span><span class="value" id="valTxt">50</span></label>
            <input id="valence" type="range" min="0" max="100" step="1" value="50" />
            <div class="sl-guide"><span>매우 부정적인</span><span>매우 긍정적인</span></div>
          </div>
          <div class="sl">
            <label><span>Arousal (각성도)</span><span class="value" id="aroTxt">50</span></label>
            <input id="arousal" type="range" min="0" max="100" step="1" value="50" />
            <div class="sl-guide"><span>매우 이완된, 차분한</span><span>매우 각성된, 강렬한</span></div>
          </div>
          <div class="controls">
            <button class="btn btn-primary" id="nextBtn" disabled>다음 곡으로</button>
          </div>
        </div>
      </div>
    </div>

    <div class="screen" id="screenEnd">
      <div class="card" style="text-align:center; max-width: 500px; margin: 60px auto;">
        <h2 style="margin-top:0;">실험이 완료되었습니다.</h2>
        <p>데이터가 성공적으로 전송되었습니다.<br>참여해주셔서 감사합니다.</p>
        <button class="btn" id="btnDownload" style="background: #333; color: #ccc; margin-top:20px;">Download Backup (JSON)</button>
      </div>
    </div>
  </div>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzRK8Ii1JMouDxNxZb7xA9jljphbq_AnT3Ho_tCeyjxF_aO057b6kXNTE6XNL59Za44/exec";
const PLAY_MS = 10000;
const DEFAULT_ART = "stimuli/no_album.jpg";

const baseStimuli = [
  { stim_id: "cheerful1", audio: "stimuli/cheerful1.mp3", art: "stimuli/cheerful1.png" },
  { stim_id: "cheerful2", audio: "stimuli/cheerful2.mp3", art: "stimuli/cheerful2.png" },
  { stim_id: "calm1",     audio: "stimuli/calm1.mp3",     art: "stimuli/calm1.png" },
  { stim_id: "calm2",     audio: "stimuli/calm2.mp3",     art: "stimuli/calm2.png" },
  { stim_id: "tense1",    audio: "stimuli/tense1.mp3",    art: "stimuli/tense1.png" },
  { stim_id: "tense2",    audio: "stimuli/tense2.mp3",    art: "stimuli/tense2.png" },
  { stim_id: "sad1",      audio: "stimuli/sad1.mp3",      art: "stimuli/sad1.png" },
  { stim_id: "sad2",      audio: "stimuli/sad2.mp3",      art: "stimuli/sad2.png" },
];

const QUEUE_KEY = "exp_fallback_queue";
function loadQueue(){ try { return JSON.parse(localStorage.getItem(QUEUE_KEY)||"[]"); } catch { return []; } }
function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }

async function sendToSheet(payload){
  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain" }, 
      body: JSON.stringify(payload),
    });
    return { ok: res.ok };
  } catch (e) { return { ok: false, error: e }; }
}

async function flushQueue(){
  const q = loadQueue();
  if(!q.length) return;
  const remain = [];
  for(const item of q){
    const r = await sendToSheet(item);
    if(!r.ok) remain.push(item);
  }
  saveQueue(remain);
}

function buildTrials(){
  const out=[];
  baseStimuli.forEach(s => {
    out.push({...s, condition:"art", show_art:true});
    out.push({...s, condition:"noart", show_art:false});
  });
  return out;
}

function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function getSmartShuffle(arr){
  let result = shuffle([...arr]);
  for(let i=1; i<result.length; i++){
    if(result[i].stim_id === result[i-1].stim_id) return getSmartShuffle(arr);
  }
  return result;
}

const trials = getSmartShuffle(buildTrials());
let participant_id = "";
let trialIndex = 0;
let results = [];
let timer = null;

function show(screenId){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function loadTrial(i){
  const t = trials[i];
  document.getElementById("counter").textContent = `${i+1} / ${trials.length}`;
  document.getElementById("status").textContent = "준비됨";
  document.getElementById("artImg").src = t.show_art ? t.art : DEFAULT_ART;
  const audio = document.getElementById("audio");
  audio.src = t.audio;
  audio.load();
  
  const nextBtn = document.getElementById("nextBtn");
  nextBtn.disabled = true;
  nextBtn.textContent = "다음 곡으로";
  
  const playBtn = document.getElementById("playBtn");
  playBtn.style.pointerEvents = "auto";
  playBtn.style.opacity = "1";
  playBtn.textContent = "PLAY";
  
  document.getElementById("valence").value = 50;
  document.getElementById("arousal").value = 50;
  updateSliderText();
}

function updateSliderText(){
  document.getElementById("valTxt").textContent = document.getElementById("valence").value;
  document.getElementById("aroTxt").textContent = document.getElementById("arousal").value;
}

document.getElementById("valence").oninput = updateSliderText;
document.getElementById("arousal").oninput = updateSliderText;

document.getElementById("btnStart").onclick = () => {
  participant_id = document.getElementById("pid").value.trim();
  if(!participant_id) return alert("ID를 입력해주세요.");
  show("screenInst");
};

document.getElementById("btnGo").onclick = () => {
  loadTrial(0);
  show("screenTrial");
};

document.getElementById("playBtn").onclick = async () => {
  const audio = document.getElementById("audio");
  const status = document.getElementById("status");
  const playBtn = document.getElementById("playBtn");
  try {
    await audio.play();
    status.textContent = "재생 중 (10초)...";
    playBtn.textContent = "WAIT";
    playBtn.style.pointerEvents = "none";
    playBtn.style.opacity = "0.7";
    if(timer) clearTimeout(timer);
    timer = setTimeout(() => {
      audio.pause(); audio.currentTime = 0;
      status.textContent = "재생 완료";
      playBtn.textContent = "PLAY";
      playBtn.style.opacity = "1";
      document.getElementById("nextBtn").disabled = false;
    }, PLAY_MS);
  } catch(e) { alert("오디오 재생 실패."); }
};


document.getElementById("nextBtn").onclick = async () => {
  const nextBtn = document.getElementById("nextBtn");
  
  // 중복 클릭 방지
  if (nextBtn.disabled) return;
  nextBtn.disabled = true;
  nextBtn.textContent = "전송 중...";

  const t = trials[trialIndex];
  const payload = {
    pid: participant_id, trial: trialIndex + 1, stim: t.stim_id,
    cond: t.condition, val: document.getElementById("valence").value,
    aro: document.getElementById("arousal").value, time: new Date().toLocaleString()
  };
  
  results.push(payload);
  const res = await sendToSheet(payload);
  if(!res.ok){ const q = loadQueue(); q.push(payload); saveQueue(q); }
  
  trialIndex++;
  if(trialIndex < trials.length){ 
    loadTrial(trialIndex); 
  } else { 
    await flushQueue(); show("screenEnd"); 
  }
};

document.getElementById("btnDownload").onclick = () => {
  const blob = new Blob([JSON.stringify(results, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `results_${participant_id}.json`;
  a.click();
};
</script>
</body>
</html>
