<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>musicplayer_pilot</title>

  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>

  <style>
    body { margin:0; background:#111; color:#eee; font-family: system-ui, -apple-system, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px 24px 24px; }

    /* DEBUG BOX */
    .debugBox{
      background:#0d1b2a;
      border:1px solid #1b3a57;
      border-radius:12px;
      padding:10px 12px;
      margin: 10px 0 14px;
      font-size: 12.5px;
      line-height: 1.35;
      color:#cfe7ff;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .debugTitle{ font-weight:700; margin-bottom:6px; }

    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; }
    .counter { font-size: 18px; opacity: .9; }
    .status  { font-size: 14px; opacity: .75; }

    .panel { display:grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    .card  { background:#1b1b1b; border:1px solid #2a2a2a; border-radius: 16px; padding: 18px; }

    .playerFrame {
      position: relative;
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      border-radius: 18px;
      overflow: hidden;
      background: #000;
      border: 1px solid #2a2a2a;

      --art-left: 12.5%;
      --art-top: 12.0%;
      --art-size: 76.0%;

      --play-left: 50%;
      --play-top: 82%;
    }

    .frameImg { width: 100%; height: auto; display:block; user-select:none; -webkit-user-drag:none; }

    .albumSlot {
      position: absolute;
      left: var(--art-left);
      top: var(--art-top);
      width: var(--art-size);
      height: var(--art-size);
      border-radius: 10px;
      overflow: hidden;
      background: #000;
    }
    .albumSlot img { width:100%; height:100%; object-fit:cover; display:block; }

    .playOverlay {
      position: absolute;
      left: var(--play-left);
      top: var(--play-top);
      transform: translate(-50%, -50%);
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      color: #111;
      min-width: 100px;
      backdrop-filter: blur(4px);
    }

    .controls { display:flex; gap: 12px; align-items:center; margin-top: 14px; justify-content:center; flex-wrap:wrap; }
    .btn-next { border:0; border-radius:999px; padding:12px 16px; font-size:16px; cursor:pointer; background:#2b6cff; color:#fff; min-width: 90px; }
    .btn-next:disabled { opacity:.45; cursor:not-allowed; }

    .hint { margin-top: 10px; font-size: 13px; opacity:.7; line-height: 1.4; text-align:center; }
    .small { font-size: 13px; opacity: .75; }

    .sl { margin: 10px 0 18px; }
    .sl label { display:flex; justify-content:space-between; align-items:center; font-size:15px; margin-bottom: 8px; }
    input[type="range"] { width:100%; }
    .value { font-variant-numeric: tabular-nums; opacity:.9; }

    @media (max-width: 860px){
      .panel { grid-template-columns: 1fr; }
      .playerFrame { max-width: 420px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="jspsych-target">
    <div class="debugBox" id="debugBox">
      <div class="debugTitle">DEBUG</div>
      Loadingâ€¦
    </div>
  </div>

<script>
/** ===== Google Script URL ===== */
const GOOGLE_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbx15kYuTQuzEXWxZnghgcGFXiYIDdUJq_LnQ-iXUmwAUZE5Jpy_gcvBMfqsnhQH4ZNN/exec";

/** ===== paths ===== */
const PLAY_MS = 10_000;
const FRAME_IMG = "stimuli/music_player.png";
const DEFAULT_ART = "stimuli/no_album.jpg";

/** ===== DEBUG helpers ===== */
const dbgEl = document.getElementById("debugBox");
let dbgLines = [];
function dbg(msg){
  dbgLines.push(msg);
  if(dbgLines.length > 40) dbgLines = dbgLines.slice(-40);
  dbgEl.textContent = "DEBUG\n" + dbgLines.join("\n");
}
window.addEventListener("error", (e) => dbg("âŒ window.error: " + (e.message || e.type)));
window.addEventListener("unhandledrejection", (e) => dbg("âŒ unhandledrejection: " + (e.reason?.message || e.reason)));

/** ===== stimuli ===== */
const baseStimuli = [
  { stim_id: "cheerful1", audio: "stimuli/cheerful1.mp3", art: "stimuli/cheerful1.png" },
  { stim_id: "cheerful2", audio: "stimuli/cheerful2.mp3", art: "stimuli/cheerful2.png" },
  { stim_id: "calm1",     audio: "stimuli/calm1.mp3",     art: "stimuli/calm1.png" },
  { stim_id: "calm2",     audio: "stimuli/calm2.mp3",     art: "stimuli/calm2.png" },
  { stim_id: "tense1",    audio: "stimuli/tense1.mp3",    art: "stimuli/tense1.png" },
  { stim_id: "tense2",    audio: "stimuli/tense2.mp3",    art: "stimuli/tense2.png" },
  { stim_id: "sad1",      audio: "stimuli/sad1.mp3",      art: "stimuli/sad1.png" },
  { stim_id: "sad2",      audio: "stimuli/sad2.mp3",      art: "stimuli/sad2.png" },
];

function buildTrials(){
  const out=[];
  for(const s of baseStimuli){
    out.push({...s, condition:"art", show_art:true});
    out.push({...s, condition:"noart", show_art:false});
  }
  return out;
}
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function shuffleNoAdjacentSame(arr, key="stim_id", maxTry=5000){
  for(let t=0;t<maxTry;t++){
    const cand=shuffle(arr);
    let ok=true;
    for(let i=1;i<cand.length;i++){
      if(cand[i][key]===cand[i-1][key]){ ok=false; break; }
    }
    if(ok) return cand;
  }
  return arr;
}

/** ===== Network send ===== */
const QUEUE_KEY = "unsent_responses_v1";
function loadQueue(){ try{ return JSON.parse(localStorage.getItem(QUEUE_KEY)||"[]"); }catch{ return []; } }
function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }

async function postToGoogleSheet(payload){
  // ì¼ë¶€ Apps ScriptëŠ” CORS/POSTë¥¼ ë§‰ëŠ” ê²½ìš°ê°€ ìˆì–´, ì‹¤íŒ¨í•˜ë©´ í™”ë©´ì— ë©”ì‹œì§€ ì°ê¸°
  const res = await fetch(GOOGLE_SCRIPT_URL, {
    method:"POST",
    mode:"cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  if(!res.ok) throw new Error(`POST ${res.status}: ${text}`);
  return text;
}

async function flushQueue(){
  const q=loadQueue();
  if(!q.length) return;
  dbg(`ğŸ“¦ queue flush start: ${q.length}`);
  const remain=[];
  let sent=0;
  for(const item of q){
    try{ await postToGoogleSheet(item); sent++; }
    catch(e){ remain.push(item); }
  }
  saveQueue(remain);
  dbg(`ğŸ“¦ queue flush done: sent=${sent}, left=${remain.length}`);
}

/** ===== Quick file checks (no F12 needed) ===== */
async function headCheck(url){
  try{
    const r = await fetch(url, { method:"GET", cache:"no-store" });
    return { ok:r.ok, status:r.status };
  } catch(e){
    return { ok:false, status:"ERR" };
  }
}
(async () => {
  dbg("ğŸ” checking key filesâ€¦");
  const checks = [
    FRAME_IMG, DEFAULT_ART,
    "stimuli/cheerful1.mp3", "stimuli/cheerful1.png"
  ];
  for(const u of checks){
    const res = await headCheck(u);
    dbg(`${res.ok ? "âœ…" : "âŒ"} ${u} (${res.status})`);
  }
  dbg("If you see âŒ 404 above, file/path mismatch is the cause.");
})();

/** ===== Trial HTML ===== */
function renderTrialHTML(t, trialIndex, totalTrials){
  const artSrc = t.show_art ? t.art : DEFAULT_ART;
  return `
    <div class="topbar">
      <div class="counter">${trialIndex}/${totalTrials}</div>
      <div class="status" id="status">ì¤€ë¹„ë¨</div>
    </div>

    <div class="panel">
      <div class="card">
        <div class="playerFrame">
          <img class="frameImg" src="${FRAME_IMG}" alt="player frame" />
          <div class="albumSlot">
            <img id="artImg" src="${artSrc}" alt="album art"/>
          </div>
          <button class="playOverlay" id="playBtn">Play</button>

          <audio id="audio" preload="auto" crossorigin="anonymous">
            <source src="${t.audio}" type="audio/mpeg" />
          </audio>
        </div>

        <div class="controls">
          <button class="btn-next" id="nextBtn" disabled>Next</button>
        </div>
        <div class="hint" id="hint">
          â€¢ Playë¥¼ ëˆ„ë¥´ë©´ 10ì´ˆ ì¬ìƒ í›„ ìë™ìœ¼ë¡œ ë©ˆì¶¥ë‹ˆë‹¤.<br/>
          â€¢ ì¬ìƒì´ 1íšŒ ì´ìƒ ì™„ë£Œë˜ì–´ì•¼ Nextê°€ í™œì„±í™”ë©ë‹ˆë‹¤.
        </div>
        <div class="hint small" id="netHint"></div>
      </div>

      <div class="card">
        <div class="sl">
          <label><span>Valence (0â€“100)</span><span class="value" id="valTxt">50</span></label>
          <input id="valence" type="range" min="0" max="100" step="1" value="50" />
        </div>
        <div class="sl">
          <label><span>Arousal (0â€“100)</span><span class="value" id="aroTxt">50</span></label>
          <input id="arousal" type="range" min="0" max="100" step="1" value="50" />
        </div>
      </div>
    </div>
  `;
}

/** ===== jsPsych timeline ===== */
const allTrials = shuffleNoAdjacentSame(buildTrials(), "stim_id");
const totalTrials = allTrials.length;
const timeline = [];

/* participant */
timeline.push({
  type: jsPsychSurveyText,
  preamble: `
    <div class="card">
      <h2>ì°¸ê°€ì ì •ë³´</h2>
      <p>ID/ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</p>
    </div>
  `,
  questions: [{ prompt:"Participant ID / Name", name:"participant_id", required:true }],
  on_finish: async (data) => {
    const resp = JSON.parse(data.responses);
    const pid = (resp.participant_id||"").trim();
    jsPsych.data.addProperties({ participant_id: pid });
    dbg("ğŸ‘¤ participant_id=" + pid);
    try { await flushQueue(); } catch {}
  }
});

/* instructions */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="card">
      <h2>ì•ˆë‚´</h2>
      <p>Playë¥¼ ëˆ„ë¥´ë©´ 10ì´ˆ ì¬ìƒë©ë‹ˆë‹¤. ì¬ìƒ í›„ VAë¥¼ í‰ê°€í•˜ê³  Nextë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
      <p class="small">ìë™ì¬ìƒì€ ë¶ˆê°€í•´ì„œ Play í´ë¦­ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    </div>
  `,
  choices: ["Start"]
});

/* preload (donâ€™t block) */
timeline.push({
  type: jsPsychPreload,
  audio: allTrials.map(t => t.audio),
  images: [...new Set(allTrials.map(t => t.art).concat([DEFAULT_ART, FRAME_IMG]))],
  show_progress_bar: true,
  continue_after_error: true,
  on_error: (file) => dbg("âš ï¸ preload failed: " + file),
});

allTrials.forEach((t, i) => {
  const trialIndex = i+1;

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: renderTrialHTML(t, trialIndex, totalTrials),
    choices: [],
    on_load: () => {
      const audio = document.getElementById("audio");
      const playBtn = document.getElementById("playBtn");
      const nextBtn = document.getElementById("nextBtn");
      const statusEl = document.getElementById("status");
      const hintEl = document.getElementById("hint");
      const netHint = document.getElementById("netHint");

      const v = document.getElementById("valence");
      const a = document.getElementById("arousal");
      const vTxt = document.getElementById("valTxt");
      const aTxt = document.getElementById("aroTxt");
      const sync = () => { vTxt.textContent=v.value; aTxt.textContent=a.value; };
      v.addEventListener("input", sync);
      a.addEventListener("input", sync);
      sync();

      let timer=null;
      let playedOnce=false;

      const enableNext = () => {
        playedOnce=true;
        nextBtn.disabled=false;
        hintEl.textContent="ì´ì œ Nextë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      };

      playBtn.addEventListener("click", async () => {
        try{
          if(audio.paused){
            await audio.play();
            statusEl.textContent="ì¬ìƒ ì¤‘ (10ì´ˆ)";
            playBtn.textContent="Pause";

            if(timer) clearTimeout(timer);
            timer=setTimeout(() => {
              audio.pause();
              audio.currentTime=0;
              statusEl.textContent="ì¬ìƒ ì™„ë£Œ";
              playBtn.textContent="Play";
              enableNext();
            }, PLAY_MS);
          } else {
            audio.pause();
            statusEl.textContent="ì¼ì‹œì •ì§€";
            playBtn.textContent="Play";
          }
        } catch(e){
          dbg("âŒ audio play error: " + e.message);
          statusEl.textContent="ì¬ìƒ ì‹¤íŒ¨(í˜¸ìŠ¤íŒ…/íŒŒì¼ í™•ì¸)";
        }
      });

      nextBtn.addEventListener("click", async () => {
        if(timer) clearTimeout(timer);
        try{ audio.pause(); audio.currentTime=0; }catch{}

        const participant_id = jsPsych.data.get().select("participant_id").values[0] || "";
        const payload = {
          participant_id,
          trial_index: trialIndex,
          total_trials: totalTrials,
          stim_id: t.stim_id,
          condition: t.condition,
          audio: t.audio,
          art_shown: t.show_art ? t.art : DEFAULT_ART,
          valence: Number(v.value),
          arousal: Number(a.value),
          played_once: playedOnce,
          client_timestamp: new Date().toISOString(),
          user_agent: navigator.userAgent
        };

        jsPsych.data.write(payload);

        netHint.textContent="ì €ì¥ ì¤‘...";
        try{
          await flushQueue();
          await postToGoogleSheet(payload);
          netHint.textContent="âœ… Google Sheet ì €ì¥ ì™„ë£Œ";
          dbg(`âœ… sent trial ${trialIndex} (${t.stim_id}/${t.condition})`);
        } catch(e){
          const q=loadQueue(); q.push(payload); saveQueue(q);
          netHint.textContent="âš ï¸ ì „ì†¡ ì‹¤íŒ¨ â†’ ì„ì‹œ ì €ì¥(ë‚˜ì¤‘ì— ì¬ì „ì†¡)";
          dbg("âš ï¸ send failed (queued): " + (e.message || e));
        }

        jsPsych.finishTrial();
      });
    }
  });
});

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div class="card" style="text-align:center;">
      <h2>ë!</h2>
      <p>ë§ˆì§€ë§‰ìœ¼ë¡œ ë¯¸ì „ì†¡ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¬ì „ì†¡ ì‹œë„í•©ë‹ˆë‹¤.</p>
    </div>
  `,
  choices: ["Finish & Download JSON"],
  on_finish: async () => {
    try { await flushQueue(); } catch {}
    const json = jsPsych.data.get().json();
    const blob = new Blob([json], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="va_data.json"; a.click();
    URL.revokeObjectURL(url);
  }
});

dbg("âœ… jsPsych init startingâ€¦");
jsPsych.init({
  display_element: "jspsych-target",
  timeline
});
</script>
</body>
</html>
